<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Local Diffusion UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: dark light;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #222, #111);
        color: #f2f2f2;
      }

      body {
        margin: 0;
        padding: 2rem;
        display: flex;
        justify-content: center;
      }

      main {
        max-width: 960px;
        width: 100%;
        background: rgba(20, 20, 20, 0.85);
        border-radius: 18px;
        box-shadow: 0 24px 48px rgba(0, 0, 0, 0.45);
        padding: 2rem 3rem 3rem;
        backdrop-filter: blur(8px);
      }

      h1 {
        font-weight: 700;
        letter-spacing: -0.02em;
        margin-bottom: 1rem;
      }

      form {
        display: grid;
        gap: 1.2rem;
      }

      textarea,
      input,
      select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        padding: 0.8rem 1rem;
        font-size: 1rem;
        background: rgba(30, 30, 30, 0.9);
        color: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      textarea:focus,
      input:focus,
      select:focus {
        outline: none;
        border-color: #66b3ff;
        box-shadow: 0 0 0 3px rgba(102, 179, 255, 0.35);
      }

      label {
        font-size: 0.9rem;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.7);
      }

      .controls {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      button {
        padding: 0.9rem 1.6rem;
        border-radius: 14px;
        border: none;
        font-weight: 600;
        font-size: 1rem;
        letter-spacing: 0.03em;
        cursor: pointer;
        background: linear-gradient(135deg, #5e81ff, #9f53ff);
        color: white;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 14px 24px rgba(94, 129, 255, 0.35);
      }

      button:disabled {
        background: rgba(255, 255, 255, 0.12);
        cursor: not-allowed;
        box-shadow: none;
      }

      #preview {
        margin-top: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        align-items: center;
      }

      #preview img {
        max-width: 100%;
        border-radius: 16px;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.42);
      }

      .status {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.75);
      }
      .banner {
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        background: rgba(94, 129, 255, 0.15);
        color: #dbe3ff;
        font-weight: 600;
      }

      .hint {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 0.35rem;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Local Diffusion</h1>
      <p id="mode-description">Generate images through the Comfy-backed FastAPI server.</p>
      <div id="pipeline-banner" class="banner">Detecting active pipeline...</div>
      <form id="generation-form">
        <label>
          Prompt
          <textarea id="prompt" rows="4" placeholder="Describe the image you want..." required></textarea>
        </label>
        <label>
          Negative Prompt
          <input id="negative" placeholder="Optional negative prompt" />
        </label>
        <label id="edit-image-wrapper" hidden>
          Image for editing
          <input id="edit-image" type="file" accept="image/*" />
          <span class="hint">Upload the photo to edit. Only used in edit mode.</span>
        </label>
        <div class="controls" id="generate-dimensions">
          <label>
            Width
            <input id="width" type="number" value="1664" step="8" min="256" max="2048" />
          </label>
          <label>
            Height
            <input id="height" type="number" value="928" step="8" min="256" max="2048" />
          </label>
          <label>
            Steps
            <input id="steps" type="number" value="50" min="1" max="200" />
          </label>
          <label>
            CFG Scale
            <input id="cfg" type="number" value="4.0" step="0.5" min="0" max="20" />
          </label>
          <label>
            Seed (optional)
            <input id="seed" type="number" placeholder="Random if blank" />
          </label>
        </div>
        <div class="controls" id="edit-dimensions" hidden>
          <label>
            Max Width
            <input id="max-width" type="number" value="1664" step="16" min="16" max="2048" />
          </label>
          <label>
            Max Height
            <input id="max-height" type="number" value="928" step="16" min="16" max="2048" />
          </label>
          <label>
            Steps
            <input id="edit-steps" type="number" value="30" min="1" max="200" />
          </label>
          <label>
            CFG Scale
            <input id="edit-cfg" type="number" value="4.0" step="0.5" min="0" max="20" />
          </label>
          <label>
            Denoise
            <input id="edit-denoise" type="number" value="1.0" step="0.05" min="0" max="1" />
            <span class="hint">Lower values keep more of the original photo.</span>
          </label>
          <label>
            Seed (optional)
            <input id="edit-seed" type="number" placeholder="Random if blank" />
          </label>
        </div>
        <label>
          Save filename (optional)
          <input id="filename" placeholder="e.g. qwen_sample.png" />
        </label>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input id="save" type="checkbox" />
            Save to disk
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem;">
            <input id="base64" type="checkbox" />
            Return base64
          </label>
        </div>
        <button type="submit" id="submit-button">Generate</button>
      </form>
      <section id="preview">
        <div class="status" id="status">Awaiting prompt...</div>
        <img id="result-image" alt="" hidden />
      </section>
    </main>
    <script>
      const form = document.getElementById("generation-form");
      const statusEl = document.getElementById("status");
      const resultImg = document.getElementById("result-image");
      const pipelineBanner = document.getElementById("pipeline-banner");
      const modeDescription = document.getElementById("mode-description");
      const submitButton = document.getElementById("submit-button");
      const generateDimensions = document.getElementById("generate-dimensions");
      const editDimensions = document.getElementById("edit-dimensions");
      const editImageWrapper = document.getElementById("edit-image-wrapper");

      let activePipeline = "generate";

      async function detectPipeline() {
        try {
          const response = await fetch("/api/status", { cache: "no-store" });
          if (!response.ok) {
            throw new Error();
          }
          const data = await response.json();
          setPipeline(data.pipeline || "generate");
        } catch {
          setPipeline("generate");
        }
      }

      function setPipeline(pipeline) {
        activePipeline = pipeline === "image-edit" ? "image-edit" : "generate";
        const isEdit = activePipeline === "image-edit";
        pipelineBanner.textContent = isEdit
          ? "Image Edit mode active — upload a photo to transform it."
          : "Text-to-image mode active — prompts create brand new scenes.";
        modeDescription.textContent = isEdit
          ? "Apply Qwen Image Edit to uploaded photos."
          : "Generate images through the Comfy-backed FastAPI server.";
        submitButton.textContent = isEdit ? "Apply Edit" : "Generate";
        generateDimensions.hidden = isEdit;
        editDimensions.hidden = !isEdit;
        editImageWrapper.hidden = !isEdit;
      }

      async function handleSubmit(event) {
        event.preventDefault();
        const button = form.querySelector("button");
        button.disabled = true;
        statusEl.textContent = "Generating image...";
        resultImg.hidden = true;

        const prompt = document.getElementById("prompt").value.trim();
        if (!prompt) {
          statusEl.textContent = "Prompt is required.";
          button.disabled = false;
          return;
        }

        try {
          let response;
          if (activePipeline === "image-edit") {
            const imageInput = document.getElementById("edit-image");
            if (!imageInput.files.length) {
              statusEl.textContent = "Please select an image to edit.";
              button.disabled = false;
              return;
            }
            const formData = new FormData();
            formData.append("prompt", prompt);
            formData.append("negative_prompt", document.getElementById("negative").value.trim());
            formData.append("max_width", document.getElementById("max-width").value);
            formData.append("max_height", document.getElementById("max-height").value);
            formData.append("steps", document.getElementById("edit-steps").value);
            formData.append("cfg_scale", document.getElementById("edit-cfg").value);
            formData.append("denoise", document.getElementById("edit-denoise").value);
            const editSeed = document.getElementById("edit-seed").value;
            if (editSeed) {
              formData.append("seed", editSeed);
            }
            formData.append("save_to_disk", document.getElementById("save").checked ? "true" : "false");
            const filename = document.getElementById("filename").value;
            if (filename) {
              formData.append("filename", filename);
            }
            formData.append("include_base64", document.getElementById("base64").checked ? "true" : "false");
            formData.append("image", imageInput.files[0]);

            response = await fetch("/api/image-edit", {
              method: "POST",
              body: formData,
            });
          } else {
            const payload = {
              prompt,
              negative_prompt: document.getElementById("negative").value.trim(),
              width: Number(document.getElementById("width").value),
              height: Number(document.getElementById("height").value),
              steps: Number(document.getElementById("steps").value),
              cfg_scale: Number(document.getElementById("cfg").value),
              seed: document.getElementById("seed").value
                ? Number(document.getElementById("seed").value)
                : null,
              save_to_disk: document.getElementById("save").checked,
              filename: document.getElementById("filename").value || null,
              include_base64: document.getElementById("base64").checked,
            };

            response = await fetch("/api/generate", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            });
          }

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || response.statusText);
          }
          const result = await response.json();
          statusEl.textContent = `Job ${result.job_id} completed. ${
            result.saved_path ? "Saved to " + result.saved_path : "Not saved."
          }`;
          if (result.base64_png) {
            resultImg.src = `data:image/png;base64,${result.base64_png}`;
            resultImg.hidden = false;
          } else {
            resultImg.src = result.image_url + `?ts=${Date.now()}`;
            resultImg.hidden = false;
          }
        } catch (error) {
          statusEl.textContent = `Error: ${error.message}`;
          resultImg.hidden = true;
        } finally {
          button.disabled = false;
        }
      }

      form.addEventListener("submit", handleSubmit);
      detectPipeline();
    </script>
  </body>
</html>
